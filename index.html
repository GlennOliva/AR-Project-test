<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cake WebXR AR â€“ Mobile Ready</title>
<script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
<style>
  html, body { margin:0; height:100%; overflow:hidden; }
  a-scene { width:100vw; height:100vh; }
  #enter-ar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; font-size:16px; background:#f90; color:#000; border:none; border-radius:8px; z-index:10; }
</style>
</head>
<body>

<button id="enter-ar">Enter AR</button>

<a-scene
    embedded
    renderer="colorManagement:true;physicallyCorrectLights:true"
    webxr="mode: ar; optionalFeatures: hit-test, light-estimation">
    
  <!-- Reticle -->
  <a-entity id="reticle"
            geometry="primitive: ring; radiusInner:0.08; radiusOuter:0.1"
            material="color: yellow; shader: flat; opacity:0.8"
            visible="false">
  </a-entity>

  <!-- Cake model -->
  <a-entity id="cakeModel"
            visible="false"
            scale="3 3 3"
            gltf-model="url(assets/cake.glb)">
  </a-entity>

  <a-light type="ambient" intensity="1"></a-light>
  <a-camera></a-camera>
</a-scene>

<script>
const scene = document.querySelector('a-scene');
const reticle = document.querySelector('#reticle');
const cake = document.querySelector('#cakeModel');
const enterARBtn = document.getElementById('enter-ar');

// Enter AR button click
enterARBtn.addEventListener('click', () => {
  if (scene.enterVR) {
    scene.enterVR(); // Triggers AR session on mobile
    enterARBtn.style.display = 'none'; // hide button
  } else {
    alert('AR not supported on this device/browser.');
  }
});

// Setup hit-test
scene.addEventListener('loaded', () => {
  scene.renderer.outputEncoding = THREE.sRGBEncoding;

  if (!scene.renderer.xr) {
    console.warn('WebXR not available on this device/browser.');
    return;
  }

  scene.renderer.xr.addEventListener('sessionstart', () => {
    const session = scene.renderer.xr.getSession();

    session.requestReferenceSpace('viewer').then(viewerSpace => {
      session.requestHitTestSource({ space: viewerSpace }).then(source => {
        session.requestReferenceSpace('local').then(localSpace => {
          scene.renderer.setAnimationLoop((time, frame) => {
            if (!frame) return;
            const hitTestResults = frame.getHitTestResults(source);
            if (hitTestResults.length) {
              const pose = hitTestResults[0].getPose(localSpace);
              reticle.object3D.visible = true;
              reticle.object3D.position.set(
                pose.transform.position.x,
                pose.transform.position.y,
                pose.transform.position.z
              );
              reticle.object3D.quaternion.set(
                pose.transform.orientation.x,
                pose.transform.orientation.y,
                pose.transform.orientation.z,
                pose.transform.orientation.w
              );
            }
          });
        });
      });
    });
  });
});

// Tap to place cake
scene.addEventListener('click', () => {
  if (reticle.object3D.visible) {
    cake.setAttribute('position', reticle.getAttribute('position'));
    cake.setAttribute('rotation', reticle.getAttribute('rotation'));
    cake.setAttribute('visible', 'true');
  }
});
</script>

</body>
</html>
