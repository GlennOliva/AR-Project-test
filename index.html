<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Cake AR (three.js + AR.js)</title>

<!-- three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/GLTFLoader.js"></script>

<!-- AR.js (three.js version) -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>

<style>
  html, body {
    margin: 0;
    overflow: hidden;
    width: 100%;
    height: 100%;
    background: #000;
  }
  canvas { display: block; }
</style>
</head>
<body>
<script>
/* ---------- Basic three.js scene ---------- */
let scene, camera, renderer, clock;
scene   = new THREE.Scene();
clock   = new THREE.Clock();
camera  = new THREE.Camera();
scene.add(camera);

renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.outputEncoding = THREE.sRGBEncoding; // important for correct colors
document.body.appendChild(renderer.domElement);

/* ---------- AR.js setup ---------- */
const arSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
arSource.init(() => setTimeout(() => onResize(), 200));

window.addEventListener('resize', () => onResize());
function onResize() {
  arSource.onResizeElement();
  arSource.copyElementSizeTo(renderer.domElement);
  if (arContext.arController !== null) {
    arSource.copyElementSizeTo(arContext.arController.canvas);
  }
}

const arContext = new THREEx.ArToolkitContext({
  cameraParametersUrl: 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/data/camera_para.dat',
  detectionMode: 'mono'
});
arContext.init(() => {
  camera.projectionMatrix.copy(arContext.getProjectionMatrix());
});

/* ---------- Marker setup ---------- */
const markerRoot = new THREE.Group();
scene.add(markerRoot);
const markerControls = new THREEx.ArMarkerControls(arContext, markerRoot, {
  type: 'pattern',
  patternUrl: 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/data/patt.hiro',
});

/* ---------- Lights ---------- */
scene.add(new THREE.AmbientLight(0xffffff, 2));
const dirLight = new THREE.DirectionalLight(0xffffff, 2);
dirLight.position.set(0,4,2);
scene.add(dirLight);
scene.add(new THREE.HemisphereLight(0xffffff,0x888888,1.2));

/* ---------- Load GLTF model ---------- */
const loader = new THREE.GLTFLoader();
loader.load('assets/cake.glb', gltf => {
    const cake = gltf.scene;
    cake.scale.set(3,3,3);
    cake.position.set(0,0.5,0);

    // optional: ensure texture uses sRGBEncoding
    cake.traverse(node => {
      if(node.isMesh && node.material.map){
        node.material.map.encoding = THREE.sRGBEncoding;
        node.material.needsUpdate = true;
      }
    });

    markerRoot.add(cake);
    console.log('✅ Cake model loaded!');
  },
  undefined,
  err => console.error('❌ Model failed to load:', err)
);

/* ---------- Render loop ---------- */
function animate() {
  requestAnimationFrame(animate);
  if (arSource.ready) arContext.update(arSource.domElement);
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
